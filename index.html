<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>codetbase - í™ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f0f0f0; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; box-sizing: border-box; padding: 0 20px; }
        .profile-card { background: white; border: 3px solid black; border-radius: 30px; padding: 20px; box-sizing: border-box; }
        .user-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .user-text h2 { margin: 0; font-size: 24px; font-weight: 900; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #000; object-fit: cover; background: #eee; }
        .gold-box { background: #eee; border-radius: 20px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-label { font-weight: 900; font-size: 22px; }
        .gold-value { color: #f39c12; font-weight: 900; font-size: 22px; }
        .top-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .top-btn { background: #ddd; border: none; border-radius: 20px; padding: 12px; font-weight: 900; font-size: 18px; cursor: pointer; }
        .banner-container { width: 100%; height: 110px; overflow: hidden; border-radius: 15px; background: #fff; border: 1px solid #ddd; margin-top: 5px; }
        .banner-item { width: 100%; height: 100%; }
        .banner-item img { width: 100%; height: 100%; display: block; object-fit: contain; background: #fff; }
        .bottom-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-btn { background: #c2cfff; border: none; border-radius: 20px; padding: 15px; font-weight: 900; font-size: 20px; cursor: pointer; transition: all 0.3s ease; }
        .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 85%; max-width: 350px; border-radius: 25px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .edit-group { margin-bottom: 15px; text-align: left; }
        .edit-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #666; }
        .edit-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-update { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-logout { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container" id="main-ui" style="display:none;">
    <div class="profile-card">
        <div class="user-info">
            <div class="user-text"><h2 id="u-nick">...</h2><h2>ì•ˆë…•í•˜ì„¸ìš”!</h2></div>
            <img id="u-avatar" src="" class="profile-img">
        </div>
        <div class="gold-box">
            <div><span class="gold-label">GOLD:</span><span class="gold-value" id="u-gold">0</span>G</div>
            <div><span class="gold-label">MONEY:</span><span class="money-value" id="u-money" style="color: #9b59b6;">0</span>M</div>
        </div>
        <div class="top-btns">
            <button class="top-btn" onclick="openRank()">ë­í‚¹</button>
            <button class="top-btn" onclick="handleDailyCheck()">ì¶œì„ì²´í¬</button>
            <button class="top-btn" onclick="showGMLogin()" style="background-color: #9b59b6;">GM</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <img src="https://i.ifh.cc/Y15g2p.png" style="width:100%; cursor:pointer;" onclick="location.href='sword.html'">
        <img src="https://i.ifh.cc/2DQFLq.png" style="width:100%; cursor:pointer;" onclick="alert('ì¤€ë¹„ì¤‘...')">
    </div>

    <div class="banner-container">
        <div class="banner-item">
            <img src="https://i.ifh.cc/W67OL2.png">
        </div>
    </div>

    <div class="bottom-menu">
        <button class="menu-btn" style="background: #ff6b6b;" onclick="startBattle()">ë°°í‹€í•˜ê¸°</button>
        <button class="menu-btn" onclick="location.href='chat.html'">ê³ ê°ì„¼í„°</button>
        <button class="menu-btn" onclick="openInfoModal()">ë‚˜ì˜ì •ë³´</button>
    </div>
</div>

<div id="info-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('info-modal')">&times;</span>
        <h2 style="text-align:center;">ğŸ‘¤ ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <div style="text-align:center; margin-bottom: 20px;">
            <img id="edit-avatar-prev" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid #ddd; object-fit:cover;">
            <input type="file" id="avatar-file" accept="image/*" style="display:none;" onchange="uploadAndPreview(this.files[0])">
            <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
                <button onclick="document.getElementById('avatar-file').click()" style="font-size:11px; cursor:pointer; padding:5px 10px;">ì‚¬ì§„ ë³€ê²½</button>
                <button onclick="resetToDefaultAvatar()" style="font-size:11px; cursor:pointer; padding:5px 10px; background:#eee; border:1px solid #ccc;">ê¸°ë³¸ ì´ë¯¸ì§€</button>
            </div>
        </div>
        <div class="edit-group">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" id="edit-nick">
        </div>
        <div class="edit-group">
            <label>ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="edit-phone">
        </div>
        <div class="edit-group">
            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
            <input type="password" id="edit-pw" placeholder="ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥">
        </div>
        <button class="btn-update" id="save-btn" onclick="saveMyInfo()">ìˆ˜ì • ë‚´ìš© ì €ì¥</button>
        <button class="btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ë°°í‹€ ë§¤ì¹­ ëª¨ë‹¬ -->
<div id="battle-matching-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cancelBattleMatching()">&times;</span>
        <h2 style="text-align:center;">âš”ï¸ ë°°í‹€ ë§¤ì¹­ ì¤‘...</h2>
        <div id="matching-status" style="text-align:center; margin: 20px 0; font-size: 18px;">
            ìƒëŒ€ë°©ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...
        </div>
        <div style="text-align:center;">
            <button class="btn-update" onclick="cancelBattleMatching()" style="background: #e74c3c;">ë§¤ì¹­ ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ë°°í‹€ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="battle-result-modal" class="modal">
    <div class="modal-content">
        <h2 style="text-align:center;" id="battle-result-title">âš”ï¸ ë°°í‹€ ê²°ê³¼</h2>
        <div id="battle-result-content" style="text-align:center; margin: 20px 0; font-size: 18px;">
            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <button class="btn-update" onclick="closeModal('battle-result-modal')" style="width:100%;">í™•ì¸</button>
    </div>
</div>

<div id="rank-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('rank-modal')">&times;</span>
        <h2 style="text-align:center;">ğŸ† TOP 10 ë­í‚¹</h2>
        <div id="rank-list"></div>
    </div>
</div>

<!-- GM Login Modal -->
<div id="gmLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h2 style="margin-bottom: 20px; text-align: center;">GM ë¡œê·¸ì¸</h2>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ì•„ì´ë””</label>
            <input type="text" id="gmUsername" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="gmPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="handleGMLogin()" style="flex: 1; padding: 12px; background-color: #9b59b6; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">ë¡œê·¸ì¸</button>
            <button onclick="hideGMLogin()" style="flex: 1; padding: 12px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DEFAULT_AVATAR = "https://www.pngarts.com/files/10/Default-Profile-Picture-Download-PNG-Image.png";
    let user = null;

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { window.location.href="login.html"; return; }
        
        const { data: p, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(error || !p) { window.location.href="login.html"; return; }
        
        user = p;
        if(user.is_banned) { alert("ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤."); handleLogout(); return; }
        
        updateUI();
        document.getElementById('main-ui').style.display = 'flex';
    }

    // GM ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showGMLogin() {
        document.getElementById('gmLoginModal').style.display = 'flex';
        document.getElementById('gmUsername').focus();
    }
    
    function hideGMLogin() {
        document.getElementById('gmLoginModal').style.display = 'none';
        document.getElementById('gmUsername').value = '';
        document.getElementById('gmPassword').value = '';
    }
    
    function handleGMLogin() {
        const username = document.getElementById('gmUsername').value.trim();
        const password = document.getElementById('gmPassword').value;
        
        if (username === 'yejun' && password === '1234321') {
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— GM ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
            sessionStorage.setItem('gmAuthenticated', 'true');
            window.location.href = 'gm.html';
        } else {
            alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            document.getElementById('gmPassword').value = '';
            document.getElementById('gmPassword').focus();
        }
    }
    
    // Enter í‚¤ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
        const gmPassword = document.getElementById('gmPassword');
        if (gmPassword) {
            gmPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleGMLogin();
                }
            });
        }
    });

    function updateUI() {
        document.getElementById('u-nick').innerText = (user.username || "í”Œë ˆì´ì–´") + "ë‹˜";
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString();
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString();
        document.getElementById('u-avatar').src = user.avatar_url || DEFAULT_AVATAR;
    }

    async function handleDailyCheck() {
        const today = new Date().toLocaleDateString();
        const lastCheck = localStorage.getItem(`daily_chk_${user.id}`);
        const lastCheckDate = localStorage.getItem(`last_check_date_${user.id}`);
        let streak = parseInt(localStorage.getItem(`checkin_streak_${user.id}`)) || 0;
        
        // Reset streak if it's a new day after missing a day
        if (lastCheckDate && lastCheckDate !== today) {
            const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
            const lastDate = new Date(lastCheckDate);
            const todayDate = new Date(today);
            const diffDays = Math.round(Math.abs((todayDate - lastDate) / oneDay));
            
            if (diffDays > 1) {
                streak = 0; // Reset streak if more than 1 day has passed
            }
        }
        
        if (lastCheck === today) return alert("ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.");
        
        // Increment streak and check for 7-day bonus
        streak = (streak % 7) + 1;
        const is7thDay = (streak % 7 === 0);
        const baseReward = 10000; // 10,000G base reward
        const bonusReward = is7thDay ? 25000 : 0; // 25,000G bonus every 7th day
        const totalReward = baseReward + bonusReward;
        
        const newGold = (parseInt(user.gold) || 0) + totalReward;
        user.gold = newGold;
        
        const { error } = await supabaseClient.from('profiles').update({ gold: newGold }).eq('id', user.id);
        if (error) { 
            alert("ì¶œì„ ì‹¤íŒ¨: " + error.message); 
        } else {
            localStorage.setItem(`daily_chk_${user.id}`, today);
            localStorage.setItem(`last_check_date_${user.id}`, today);
            localStorage.setItem(`checkin_streak_${user.id}`, streak);
            
            let message = `${baseReward.toLocaleString()}G ì¶œì„ ì™„ë£Œ!`;
            if (is7thDay) {
                message = `ì¶•í•˜í•©ë‹ˆë‹¤! 7ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤ ${totalReward.toLocaleString()}G ì§€ê¸‰!`;
            }
            alert(message);
            updateUI();
        }
    }

    function openInfoModal() {
        document.getElementById('edit-nick').value = user.nickname || "";
        document.getElementById('edit-phone').value = user.phone || "";
        document.getElementById('edit-pw').value = "";
        document.getElementById('edit-avatar-prev').src = user.avatar_url || DEFAULT_AVATAR;
        openModal('info-modal');
    }

    function resetToDefaultAvatar() { 
        document.getElementById('edit-avatar-prev').src = DEFAULT_AVATAR; 
    }

    async function uploadAndPreview(file) {
        if(!file) return;
        
        const saveBtn = document.getElementById('save-btn');
        const prevText = saveBtn.innerText;
        saveBtn.disabled = true;
        saveBtn.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";

        try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}_${Date.now()}.${fileExt}`;
            const filePath = `avatars/${fileName}`;

            const { error: uploadError } = await supabaseClient.storage
                .from('codet-img')
                .upload(filePath, file);

            if(uploadError) throw uploadError;

            const { data: { publicUrl } } = supabaseClient.storage
                .from('codet-img')
                .getPublicUrl(filePath);

            document.getElementById('edit-avatar-prev').src = publicUrl;

        } catch (error) {
            console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—ëŸ¬:", error);
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = prevText;
        }
    }

    async function saveMyInfo() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const newNick = document.getElementById('edit-nick').value.trim();
        const newPhone = document.getElementById('edit-phone').value.trim();
        const newAvatar = document.getElementById('edit-avatar-prev').src;
        const newPw = document.getElementById('edit-pw').value;

        // Check if nickname is empty
        if (!newNick) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
            btn.disabled = false;
            return;
        }

        // Only check for duplicate if nickname has changed
        if (newNick !== user.nickname) {
            try {
                // Check if nickname already exists
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('nickname', newNick)
                    .single();

                if (existingUser) {
                    throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!');
                }
            } catch (error) {
                if (error.message !== 'No rows found') {
                    // If the error is not "not found" (which means nickname is available)
                    btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
                    btn.disabled = false;
                    alert(error.message);
                    return;
                }
            }
        }

        const updateData = {
            nickname: newNick,
            phone: newPhone,
            avatar_url: newAvatar
        };

        try {
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update(updateData)
                .eq('id', user.id);

            if(updateError) throw updateError;

            if(newPw && newPw.length >= 6) { 
                const { error: pwError } = await supabaseClient.auth.updateUser({ password: newPw });
                if(pwError) throw pwError;
            }

            alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
        } catch (e) {
            console.error("ì €ì¥ ì˜¤ë¥˜:", e);
            alert("ì €ì¥ ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
            btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
            btn.disabled = false;
        }
    }

    async function openRank() {
        openModal('rank-modal');
        const { data } = await supabaseClient
            .from('profiles')
            .select('nickname, gold')
            .order('gold', { ascending: false })
            .limit(10);
            
        document.getElementById('rank-list').innerHTML = (data || []).map((u, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                <span>${i+1}ìœ„ ${u.nickname || 'ìµëª…'}</span>
                <b>${(u.gold||0).toLocaleString()}G</b>
            </div>
        `).join('');
    }

    async function handleLogout() { 
        await supabaseClient.auth.signOut(); 
        window.location.href = "login.html"; 
    }
    
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // ë°°í‹€ ê´€ë ¨ ë³€ìˆ˜
    let battleSubscription = null;
    let currentBattle = null;
    let myId = null;
    let myNick = '';

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œ í˜¸ì¶œ
    async function loadUserInfo() {
        try {
            const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
            if (userError) throw userError;
            
            if (user) {
                myId = user.id;
                // ì‚¬ìš©ì ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('nickname')
                    .eq('id', user.id)
                    .single();
                    
                if (profileError) throw profileError;
                
                if (profile) {
                    myNick = profile.nickname || 'í”Œë ˆì´ì–´';
                }
                
                // ë°°í‹€ ìƒíƒœ êµ¬ë… ì‹œì‘
                setupBattleSubscription();
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ë°°í‹€ ìƒíƒœ ë³€ê²½ êµ¬ë… ì„¤ì •
    function setupBattleSubscription() {
        if (!myId) return;
        
        // ê¸°ì¡´ êµ¬ë… í•´ì œ
        if (battleSubscription) {
            supabaseClient.removeChannel(battleSubscription);
        }

        // ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
        battleSubscription = supabaseClient
            .channel('battles')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'battles',
                filter: `player1_id=eq.${myId}||player2_id=eq.${myId}`, // ë‚´ê°€ ì°¸ì—¬ì¤‘ì¸ ë°°í‹€ë§Œ í•„í„°ë§
            }, handleBattleUpdate)
            .subscribe();
    }

    // ë°°í‹€ ì‹œì‘ í•¨ìˆ˜
    async function startBattle() {
        try {
            // ë°°í‹€ ë§¤ì¹­ ì‹œì‘
            const { data: battle, error } = await supabaseClient
                .from('battles')
                .insert([
                    { 
                        player1_id: myId,
                        player1_nickname: myNick,
                        status: 'waiting',
                        current_player_id: myId
                    }
                ])
                .select()
                .single();

            if (error) throw error;

            // í˜„ì¬ ë°°í‹€ ì •ë³´ ì €ì¥
            currentBattle = {
                id: battle.id,
                status: 'waiting',
                isMyTurn: true
            };

            // ë§¤ì¹­ ì¤‘ ëª¨ë‹¬ í‘œì‹œ
            openModal('battle-matching-modal');
            updateBattleUI();

            // 30ì´ˆ í›„ì— ìë™ìœ¼ë¡œ ë§¤ì¹­ ì·¨ì†Œ
            setTimeout(async () => {
                if (currentBattle && currentBattle.status === 'waiting') {
                    await cancelBattleMatching();
                    alert('ë§¤ì¹­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }, 30000);

        } catch (error) {
            console.error('ë°°í‹€ ì‹œì‘ ì˜¤ë¥˜:', error);
            alert('ë°°í‹€ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ë°°í‹€ ë§¤ì¹­ ì·¨ì†Œ
    async function cancelBattleMatching() {
        if (!currentBattle) return;
        
        try {
            await supabaseClient
                .from('battles')
                .delete()
                .eq('id', currentBattle.id);
        } catch (error) {
            console.error('ë°°í‹€ ë§¤ì¹­ ì·¨ì†Œ ì˜¤ë¥˜:', error);
        } finally {
            currentBattle = null;
            closeModal('battle-matching-modal');
        }
    }

    // ë°°í‹€ UI ì—…ë°ì´íŠ¸
    function updateBattleUI() {
        if (!currentBattle) return;
        
        const matchingModal = document.getElementById('battle-matching-modal');
        const matchingText = document.getElementById('battle-matching-text');
        
        if (currentBattle.status === 'waiting') {
            matchingText.textContent = 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...';
        } else if (currentBattle.opponent) {
            matchingText.textContent = `${currentBattle.opponent}ë‹˜ê³¼ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤!`;
            // 2ì´ˆ í›„ì— ë°°í‹€ ì‹œì‘
            setTimeout(() => {
                if (currentBattle) {
                    currentBattle.status = 'in_progress';
                    updateBattleUI();
                }
            }, 2000);
        } else if (currentBattle.status === 'in_progress') {
            closeModal('battle-matching-modal');
            // ì—¬ê¸°ì— ë°°í‹€ ì§„í–‰ UI í‘œì‹œ ë¡œì§ ì¶”ê°€
        }
    }

    // ë°°í‹€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    async function handleBattleUpdate(payload) {
        try {
            const battle = payload.new || payload.old;
            
            switch(payload.eventType) {
                case 'INSERT': // ìƒˆ ë°°í‹€ ìƒì„±ë¨
                    if (battle.player2_id) { // ìƒëŒ€ë°©ì´ ë§¤ì¹­ëœ ê²½ìš°
                        currentBattle = {
                            id: battle.id,
                            opponent: battle.player2_nickname,
                            opponentId: battle.player2_id,
                            status: 'matching',
                            isMyTurn: battle.current_player_id === myId
                        };
                        updateBattleUI();
                    }
                    break;
                    
                case 'UPDATE': // ë°°í‹€ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (battle.status === 'in_progress') {
                        // ë°°í‹€ ê²°ê³¼ ì²˜ë¦¬
                        const isWinner = battle.winner_id === myId;
                        const goldEarned = isWinner ? 100 : 10;
                        
                        // ê³¨ë“œ ì—…ë°ì´íŠ¸
                        const currentGold = parseInt(document.getElementById('u-gold').textContent) || 0;
                        document.getElementById('u-gold').textContent = currentGold + goldEarned;
                        
                        // ìŠ¹ë¦¬ ì‹œ ìƒëŒ€ë°©ì—ê²Œì„œ 10% íšë“
                        if (isWinner && currentBattle && currentBattle.moneyLost) {
                            const currentMoney = parseInt(document.getElementById('u-money').textContent) || 0;
                            document.getElementById('u-money').textContent = currentMoney + currentBattle.moneyLost;
                        }
                        
                        // ê²°ê³¼ í‘œì‹œ
                        showBattleResult(isWinner, battle.winner_nickname, goldEarned);
                        
                        // ì„œë²„ì— ê³¨ë“œ ì—…ë°ì´íŠ¸
                        await updateGold(goldEarned);
                    } else if (battle.status === 'completed') {
                        // ë°°í‹€ ê²°ê³¼ ì²˜ë¦¬
                        const isWinner = battle.winner_id === myId;
                        const goldEarned = isWinner ? 100 : 10;
                        
                        // íŒ¨ì ëˆ 10% ì°¨ê° ë° ìŠ¹ìì—ê²Œ ì „ë‹¬
                        try {
                            // ìŠ¹ìì™€ íŒ¨ì ID ê²°ì •
                            const winnerId = battle.winner_id;
                            const loserId = winnerId === myId ? currentBattle.opponentId : myId;
                            
                            // íŒ¨ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                            const { data: loserProfile } = await supabase
                                .from('profiles')
                                .select('money, nickname')
                                .eq('id', loserId)
                                .single();
                                
                            if (loserProfile) {
                                const moneyToLose = Math.floor(parseInt(loserProfile.money || 0) * 0.1);
                                
                                // íŒ¨ì ëˆ ì°¨ê° (0 ì´í•˜ë¡œëŠ” ë‚´ë ¤ê°€ì§€ ì•ŠìŒ)
                                const newLoserMoney = Math.max(0, (parseInt(loserProfile.money) || 0) - moneyToLose);
                                await supabase
                                    .from('profiles')
                                    .update({ money: newLoserMoney })
                                    .eq('id', loserId);
                                
                                // ìŠ¹ìì—ê²Œ ëˆ ì¶”ê°€
                                if (isWinner) {
                                    const currentMoney = parseInt(document.getElementById('u-money').textContent) || 0;
                                    document.getElementById('u-money').textContent = currentMoney + moneyToLose;
                                    
                                    // ì„œë²„ì—ë„ ìŠ¹ì ëˆ ì—…ë°ì´íŠ¸
                                    await supabase.rpc('increment_money', {
                                        user_id: myId,
                                        amount: moneyToLose
                                    });
                                } else {
                                    // íŒ¨ë°°ì í™”ë©´ ì—…ë°ì´íŠ¸
                                    const currentMoney = parseInt(document.getElementById('u-money').textContent) || 0;
                                    document.getElementById('u-money').textContent = newLoserMoney;
                                }
                                
                                // ë°°í‹€ ê²°ê³¼ì— ì°¨ê°ëœ ê¸ˆì•¡ ì €ì¥ (UI í‘œì‹œìš©)
                                currentBattle.moneyLost = moneyToLose;
                                currentBattle.loserNick = loserProfile.nickname || 'ìƒëŒ€ë°©';
                            }
                        } catch (error) {
                            console.error('ë°°í‹€ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                        }
                        
                        // ê³¨ë“œ ì—…ë°ì´íŠ¸ ë° ê²°ê³¼ í‘œì‹œ
                        const currentGold = parseInt(document.getElementById('u-gold').textContent) || 0;
                        document.getElementById('u-gold').textContent = currentGold + goldEarned;
                        
                        // ì„œë²„ì— ê³¨ë“œ ì—…ë°ì´íŠ¸
                        await updateGold(goldEarned);
                        
                        // ê²°ê³¼ í‘œì‹œ
                        showBattleResult(isWinner, battle.winner_nickname || 'ìƒëŒ€ë°©', goldEarned);
                    }
                    break;
            }
        } catch (error) {
            console.error('ë°°í‹€ ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    }

    // ê³¨ë“œ ì—…ë°ì´íŠ¸
    async function updateGold(amount) {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('gold')
                    .eq('id', user.id)
                    .single();
                
                if (profile) {
                    await supabase
                        .from('profiles')
                        .update({ gold: (parseInt(profile.gold) || 0) + amount })
                        .eq('id', user.id);
                }
            }
        } catch (error) {
            console.error('ê³¨ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ë°°í‹€ ê²°ê³¼ í‘œì‹œ
    function showBattleResult(isWin, winnerNick, goldEarned) {
        const resultTitle = document.getElementById('battle-result-title');
        const resultContent = document.getElementById('battle-result-content');
        
        if (isWin) {
            // ìŠ¹ë¦¬ ì‹œ
            resultTitle.textContent = 'ğŸ‰ ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰';
            resultContent.innerHTML = `
                <p>ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${currentBattle.opponent}</strong>ë‹˜ì„ ìƒëŒ€ë¡œ ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                <p style="color: #f39c12; font-weight: bold; font-size: 24px;">+${goldEarned}G íšë“!</p>
                ${currentBattle.moneyLost ? 
                    `<p style="color: #2ecc71; font-weight: bold;">ìƒëŒ€ë°©ì—ê²Œì„œ ${currentBattle.moneyLost.toLocaleString()}Mì„ íšë“í–ˆìŠµë‹ˆë‹¤!</p>` : ''}
            `;
        } else {
            // íŒ¨ë°° ì‹œ
            const moneyLost = currentBattle.moneyLost || 0;
            resultTitle.textContent = 'ğŸ˜¢ ì•„ì‰½ê²Œ ì¡ŒìŠµë‹ˆë‹¤...';
            resultContent.innerHTML = `
                <p><strong>${winnerNick}</strong>ë‹˜ì—ê²Œ íŒ¨ë°°í•˜ì…¨ìŠµë‹ˆë‹¤...</p>
                <p>ë³´ìœ  ê¸ˆì•¡ì˜ 10%ë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤.</p>
                <p style="color: #e74c3c; font-weight: bold; font-size: 20px;">-${moneyLost.toLocaleString()}M</p>
                <p>ìœ„ë¡œì˜ ìƒê¸ˆ: ${goldEarned}G</p>
            `;
        }
        
        // ë°°í‹€ ìƒíƒœ ì´ˆê¸°í™”
        currentBattle = null;
        
        // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        openModal('battle-result-modal');
    }

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° ë°°í‹€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        init().then(() => {
            // Supabase ì´ˆê¸°í™”ê°€ ì™„ë£Œëœ í›„ì—ë§Œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            if (supabaseClient) {
                loadUserInfo();
            } else {
                console.error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        }).catch(error => {
            console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        });
    });
</script>
</body>
</html>
