<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²€ ê°•í™” ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .game-container { width: 100%; max-width: 400px; background: white; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        #ban-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        #full-effect { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: white; pointer-events: none; text-align: center; }

        .header { background: #2c3e50; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .gold-wrap { display: flex; align-items: center; gap: 8px; position: relative; }
        .code-btn { background: #f1c40f; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }

        .money-float { position: absolute; right: 40px; top: -10px; font-weight: 900; font-size: 22px; animation: floatUp 3s forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 10% { opacity: 1; } 100% { opacity: 0; transform: translateY(-80px); } }

        .top-bar { width: 100%; max-width: 400px; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .check-btn { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .img-area { background: #f0f0f0; height: 210px; margin: 15px; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .sword-img { max-width: 75%; max-height: 75%; object-fit: contain; }
        .hammering { animation: hammer 0.1s infinite; }
        @keyframes hammer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .btn-group { padding: 15px; display: flex; gap: 8px; }
        .btn-main { flex: 2; padding: 16px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; background: #2c3e50; color: white; }
        .btn-sub { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
        
        .rank-box { width: 100%; max-width: 400px; background: white; margin-top: 15px; border-radius: 20px; padding: 15px; box-sizing: border-box; }
        .rank-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>
<div id="loading">ë¡œë”© ì¤‘...</div>

<div id="ban-overlay"><h1>ğŸš«</h1><h2>ì„ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2><p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p></div>
<div id="full-effect"></div>

<div class="top-bar">
    <button class="check-btn" onclick="dailyCheck()">ğŸ“… ì¶œì„ì²´í¬</button>
</div>

<div class="game-container" id="game-ui">
    <div class="header">
        <span id="u-nick" style="font-size: 14px;">...ë‹˜</span>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color: #f1c40f; font-weight: bold;">0G</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
        </div>
    </div>

    <div style="padding: 12px 15px; font-size: 13px;"><b>ë£¨ëŒí”„:</b> <span id="npc-text">ë°˜ê°‘ë„¤! ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?</span></div>
    
    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>
    
    <div style="padding: 0 20px 10px;">
        <div id="s-name" style="font-size: 19px; font-weight: bold;">...</div>
        <div id="s-desc" style="font-size: 12px; color: #7f8c8d; margin-top: 4px;">...</div>
        <div id="s-info" style="font-size: 13px; color: #2c3e50; margin-top: 8px; font-weight: bold;">ê°•í™”: 0G | íŒë§¤: 0G | í™•ë¥ : 0%</div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<div class="rank-box">
    <h4 style="margin:0 0 8px 0;">ğŸ† ì „ì„¤ì˜ ìˆœìœ„</h4>
    <div id="rank-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { location.href="login.html"; return; }
        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(p.is_banned) { document.getElementById('loading').style.display='none'; document.getElementById('ban-overlay').style.display='flex'; return; }
        user = p;
        const { data: s } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
        s.forEach(i => swords[i.level] = i);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        updateUI(); loadRank();
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-nick').innerText = user.nickname + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
        
        // ìˆ˜ì • í¬ì¸íŠ¸: item.level-1 ëŒ€ì‹  item.levelì„ ì‚¬ìš©í•˜ì—¬ +1ë¶€í„° ì‹œì‘í•˜ê²Œ í•¨
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        
        document.getElementById('s-desc').innerText = item.description || "ì„¤ëª… ì—†ìŒ";
        document.getElementById('s-info').innerText = `ê°•í™”: ${item.upgrade_cost.toLocaleString()}G | íŒë§¤: ${(item.sell_price || 0).toLocaleString()}G | í™•ë¥ : ${item.success_rate*100}%`;
        document.getElementById('s-img').src = item.image_url;
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    async function dailyCheck() {
        const lastCheck = localStorage.getItem(`check_${user.id}`);
        const today = new Date().toDateString();
        if(lastCheck === today) return alert("ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤!");
        const reward = Number(localStorage.getItem('codet_daily')) || 5000;
        user.gold += reward;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        localStorage.setItem(`check_${user.id}`, today);
        showGoldEffect(reward, true);
        alert(`ì¶œì„ ì™„ë£Œ! +${reward.toLocaleString()}G`);
        updateUI(); loadRank();
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) return alert("ê³¨ë“œ ë¶€ì¡±!");
        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        showGoldEffect(s.upgrade_cost, false);
        
        const success = Math.random() < s.success_rate;
        let nextLvl;
        
        if (success) {
            nextLvl = user.current_sword_lvl + 1;
            if (!swords[nextLvl]) { 
                img.classList.remove('hammering'); 
                return alert("ìµœê³  ë ˆë²¨!"); 
            }
        } else {
            nextLvl = Math.max(1, user.current_sword_lvl - 1);
        }

        user.gold -= s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);
        
        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = nextLvl;
            showEffect(success);
            updateUI(); loadRank();
        }, 600);
    }

    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        el.innerText = success ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨!\n-1LV";
        setTimeout(() => { el.style.display = 'none'; }, 800); 
    }

    async function handleSell() {
        const item = swords[user.current_sword_lvl];
        if(user.current_sword_lvl === 1) return alert("ê¸°ë³¸ ê²€ì€ íŒë§¤ ë¶ˆê°€!");
        const price = item.sell_price || 0;
        if(!confirm(`${item.name}ì„ ${price.toLocaleString()}Gì— íŒŒì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        user.gold += price;
        user.current_sword_lvl = 1;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);
        showGoldEffect(price, true);
        alert(`íŒë§¤ ì™„ë£Œ! +${price.toLocaleString()}G`);
        updateUI(); loadRank();
    }

    async function redeem() {
        const code = prompt("ì½”ë“œ ì…ë ¥");
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if(!data) return alert("ì½”ë“œ ì˜¤ë¥˜");
        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        showGoldEffect(data.reward_gold, true);
        updateUI(); loadRank();
    }

    async function loadRank() {
        const { data } = await supabaseClient.from('profiles').select('nickname, gold').order('gold', { ascending: false }).limit(5);
        document.getElementById('rank-list').innerHTML = data.map((r, i) => `
            <div class="rank-item"><span>${i+1}. ${r.nickname}</span><b>${r.gold.toLocaleString()}G</b></div>`).join('');
    }
    init();
</script>
</body>
</html>

