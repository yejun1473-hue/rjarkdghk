<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>codetbase - í™ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f0f0f0; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; box-sizing: border-box; padding: 0 20px; }
        .profile-card { background: white; border: 3px solid black; border-radius: 30px; padding: 20px; box-sizing: border-box; }
        .user-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .user-text h2 { margin: 0; font-size: 24px; font-weight: 900; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #000; object-fit: cover; background: #eee; }
        .gold-box { background: #eee; border-radius: 20px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-label { font-weight: 900; font-size: 22px; }
        .gold-value { color: #f39c12; font-weight: 900; font-size: 22px; }
        .top-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .top-btn { background: #ddd; border: none; border-radius: 20px; padding: 12px; font-weight: 900; font-size: 18px; cursor: pointer; }
        .banner-container { width: 100%; height: 110px; overflow: hidden; border-radius: 15px; background: #fff; border: 1px solid #ddd; margin-top: 5px; }
        .banner-item { width: 100%; height: 100%; }
        .banner-item img { width: 100%; height: 100%; display: block; object-fit: contain; background: #fff; }
        .bottom-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-btn { background: #c2cfff; border: none; border-radius: 20px; padding: 15px; font-weight: 900; font-size: 20px; cursor: pointer; transition: all 0.3s ease; }
        .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 85%; max-width: 350px; border-radius: 25px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .edit-group { margin-bottom: 15px; text-align: left; }
        .edit-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #666; }
        .edit-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-update { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-logout { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container" id="main-ui" style="display:none;">
    <div class="profile-card">
        <div class="user-info">
            <div class="user-text"><h2 id="u-nick">...</h2><h2>ì•ˆë…•í•˜ì„¸ìš”!</h2></div>
            <img id="u-avatar" src="" class="profile-img">
        </div>
        <div class="gold-box">
            <div><span class="gold-label">GOLD:</span><span class="gold-value" id="u-gold">0</span>G</div>
            <div><span class="gold-label">MONEY:</span><span class="money-value" id="u-money" style="color: #9b59b6;">0</span>M</div>
        </div>
        <div class="top-btns">
            <button class="top-btn" onclick="openRank()">ë­í‚¹</button>
            <button class="top-btn" onclick="handleDailyCheck()">ì¶œì„ì²´í¬</button>
            <button class="top-btn" onclick="showGMLogin()" style="background-color: #9b59b6;">GM</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <img src="https://i.ifh.cc/Y15g2p.png" style="width:100%; cursor:pointer;" onclick="location.href='sword.html'">
        <img src="https://i.ifh.cc/2DQFLq.png" style="width:100%; cursor:pointer;" onclick="alert('ì¤€ë¹„ì¤‘...')">
    </div>

    <div class="banner-container">
        <div class="banner-item">
            <img src="https://i.ifh.cc/W67OL2.png">
        </div>
    </div>

    <div class="bottom-menu">
        <button class="menu-btn" style="background: #ff6b6b;" onclick="startBattle()">ë°°í‹€í•˜ê¸°</button>
        <button class="menu-btn" onclick="location.href='chat.html'">ê³ ê°ì„¼í„°</button>
        <button class="menu-btn" onclick="openInfoModal()">ë‚˜ì˜ì •ë³´</button>
    </div>
</div>

<div id="info-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('info-modal')">&times;</span>
        <h2 style="text-align:center;">ğŸ‘¤ ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <div style="text-align:center; margin-bottom: 20px;">
            <img id="edit-avatar-prev" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid #ddd; object-fit:cover;">
            <input type="file" id="avatar-file" accept="image/*" style="display:none;" onchange="uploadAndPreview(this.files[0])">
            <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
                <button onclick="document.getElementById('avatar-file').click()" style="font-size:11px; cursor:pointer; padding:5px 10px;">ì‚¬ì§„ ë³€ê²½</button>
                <button onclick="resetToDefaultAvatar()" style="font-size:11px; cursor:pointer; padding:5px 10px; background:#eee; border:1px solid #ccc;">ê¸°ë³¸ ì´ë¯¸ì§€</button>
            </div>
        </div>
        <div class="edit-group">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" id="edit-nick">
        </div>
        <div class="edit-group">
            <label>ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="edit-phone">
        </div>
        <div class="edit-group">
            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
            <input type="password" id="edit-pw" placeholder="ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥">
        </div>
        <button class="btn-update" id="save-btn" onclick="saveMyInfo()">ìˆ˜ì • ë‚´ìš© ì €ì¥</button>
        <button class="btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ë°°í‹€ ë§¤ì¹­ ëª¨ë‹¬ -->
<div id="battle-matching-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cancelBattleMatching()">&times;</span>
        <h2 style="text-align:center;">âš”ï¸ ë°°í‹€ ë§¤ì¹­ ì¤‘...</h2>
        <div id="matching-status" style="text-align:center; margin: 20px 0; font-size: 18px;">
            ìƒëŒ€ë°©ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...
        </div>
        <div style="text-align:center;">
            <button class="btn-update" onclick="cancelBattleMatching()" style="background: #e74c3c;">ë§¤ì¹­ ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ë°°í‹€ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="battle-result-modal" class="modal">
    <div class="modal-content">
        <h2 style="text-align:center;" id="battle-result-title">âš”ï¸ ë°°í‹€ ê²°ê³¼</h2>
        <div id="battle-result-content" style="text-align:center; margin: 20px 0; font-size: 18px;">
            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <button class="btn-update" onclick="closeModal('battle-result-modal')" style="width:100%;">í™•ì¸</button>
    </div>
</div>

<div id="rank-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('rank-modal')">&times;</span>
        <h2 style="text-align:center;">ğŸ† TOP 10 ë­í‚¹</h2>
        <div id="rank-list"></div>
    </div>
</div>

<!-- GM Login Modal -->
<div id="gmLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h2 style="margin-bottom: 20px; text-align: center;">GM ë¡œê·¸ì¸</h2>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ì•„ì´ë””</label>
            <input type="text" id="gmUsername" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="gmPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="handleGMLogin()" style="flex: 1; padding: 12px; background-color: #9b59b6; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">ë¡œê·¸ì¸</button>
            <button onclick="hideGMLogin()" style="flex: 1; padding: 12px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DEFAULT_AVATAR = "https://www.pngarts.com/files/10/Default-Profile-Picture-Download-PNG-Image.png";
    let user = null;

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { window.location.href="login.html"; return; }
        
        const { data: p, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(error || !p) { window.location.href="login.html"; return; }
        
        user = p;
        if(user.is_banned) { alert("ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤."); handleLogout(); return; }
        
        updateUI();
        document.getElementById('main-ui').style.display = 'flex';
    }

    // GM ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showGMLogin() {
        document.getElementById('gmLoginModal').style.display = 'flex';
        document.getElementById('gmUsername').focus();
    }
    
    function hideGMLogin() {
        document.getElementById('gmLoginModal').style.display = 'none';
        document.getElementById('gmUsername').value = '';
        document.getElementById('gmPassword').value = '';
    }
    
    function handleGMLogin() {
        const username = document.getElementById('gmUsername').value.trim();
        const password = document.getElementById('gmPassword').value;
        
        if (username === 'yejun' && password === '1234321') {
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— GM ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
            sessionStorage.setItem('gmAuthenticated', 'true');
            window.location.href = 'gm.html';
        } else {
            alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            document.getElementById('gmPassword').value = '';
            document.getElementById('gmPassword').focus();
        }
    }
    
    // Enter í‚¤ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
        const gmPassword = document.getElementById('gmPassword');
        if (gmPassword) {
            gmPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleGMLogin();
                }
            });
        }
    });

    function updateUI() {
        document.getElementById('u-nick').innerText = (user.username || "í”Œë ˆì´ì–´") + "ë‹˜";
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString();
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString();
        document.getElementById('u-avatar').src = user.avatar_url || DEFAULT_AVATAR;
    }

    async function handleDailyCheck() {
        const today = new Date().toLocaleDateString();
        const lastCheck = localStorage.getItem(`daily_chk_${user.id}`);
        const lastCheckDate = localStorage.getItem(`last_check_date_${user.id}`);
        let streak = parseInt(localStorage.getItem(`checkin_streak_${user.id}`)) || 0;
        
        // Reset streak if it's a new day after missing a day
        if (lastCheckDate && lastCheckDate !== today) {
            const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
            const lastDate = new Date(lastCheckDate);
            const todayDate = new Date(today);
            const diffDays = Math.round(Math.abs((todayDate - lastDate) / oneDay));
            
            if (diffDays > 1) {
                streak = 0; // Reset streak if more than 1 day has passed
            }
        }
        
        if (lastCheck === today) return alert("ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.");
        
        // Increment streak and check for 7-day bonus
        streak = (streak % 7) + 1;
        const is7thDay = (streak % 7 === 0);
        const baseReward = 10000; // 10,000G base reward
        const bonusReward = is7thDay ? 25000 : 0; // 25,000G bonus every 7th day
        const totalReward = baseReward + bonusReward;
        
        const newGold = (parseInt(user.gold) || 0) + totalReward;
        user.gold = newGold;
        
        const { error } = await supabaseClient.from('profiles').update({ gold: newGold }).eq('id', user.id);
        if (error) { 
            alert("ì¶œì„ ì‹¤íŒ¨: " + error.message); 
        } else {
            localStorage.setItem(`daily_chk_${user.id}`, today);
            localStorage.setItem(`last_check_date_${user.id}`, today);
            localStorage.setItem(`checkin_streak_${user.id}`, streak);
            
            let message = `${baseReward.toLocaleString()}G ì¶œì„ ì™„ë£Œ!`;
            if (is7thDay) {
                message = `ì¶•í•˜í•©ë‹ˆë‹¤! 7ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤ ${totalReward.toLocaleString()}G ì§€ê¸‰!`;
            }
            alert(message);
            updateUI();
        }
    }

    function openInfoModal() {
        document.getElementById('edit-nick').value = user.nickname || "";
        document.getElementById('edit-phone').value = user.phone || "";
        document.getElementById('edit-pw').value = "";
        document.getElementById('edit-avatar-prev').src = user.avatar_url || DEFAULT_AVATAR;
        openModal('info-modal');
    }

    function resetToDefaultAvatar() { 
        document.getElementById('edit-avatar-prev').src = DEFAULT_AVATAR; 
    }

    async function uploadAndPreview(file) {
        if(!file) return;
        
        const saveBtn = document.getElementById('save-btn');
        const prevText = saveBtn.innerText;
        saveBtn.disabled = true;
        saveBtn.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";

        try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}_${Date.now()}.${fileExt}`;
            const filePath = `avatars/${fileName}`;

            const { error: uploadError } = await supabaseClient.storage
                .from('codet-img')
                .upload(filePath, file);

            if(uploadError) throw uploadError;

            const { data: { publicUrl } } = supabaseClient.storage
                .from('codet-img')
                .getPublicUrl(filePath);

            document.getElementById('edit-avatar-prev').src = publicUrl;

        } catch (error) {
            console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—ëŸ¬:", error);
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = prevText;
        }
    }

    async function saveMyInfo() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const newNick = document.getElementById('edit-nick').value.trim();
        const newPhone = document.getElementById('edit-phone').value.trim();
        const newAvatar = document.getElementById('edit-avatar-prev').src;
        const newPw = document.getElementById('edit-pw').value;

        // Check if nickname is empty
        if (!newNick) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
            btn.disabled = false;
            return;
        }

        // Only check for duplicate if nickname has changed
        if (newNick !== user.nickname) {
            try {
                // Check if nickname already exists
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('nickname', newNick)
                    .single();

                if (existingUser) {
                    throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!');
                }
            } catch (error) {
                if (error.message !== 'No rows found') {
                    // If the error is not "not found" (which means nickname is available)
                    btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
                    btn.disabled = false;
                    alert(error.message);
                    return;
                }
            }
        }

        const updateData = {
            nickname: newNick,
            phone: newPhone,
            avatar_url: newAvatar
        };

        try {
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update(updateData)
                .eq('id', user.id);

            if(updateError) throw updateError;

            if(newPw && newPw.length >= 6) { 
                const { error: pwError } = await supabaseClient.auth.updateUser({ password: newPw });
                if(pwError) throw pwError;
            }

            alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.reload();
        } catch (e) {
            console.error("ì €ì¥ ì˜¤ë¥˜:", e);
            alert("ì €ì¥ ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
            btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
            btn.disabled = false;
        }
    }

    async function openRank() {
        openModal('rank-modal');
        const { data } = await supabaseClient
            .from('profiles')
            .select('nickname, gold')
            .order('gold', { ascending: false })
            .limit(10);
            
        document.getElementById('rank-list').innerHTML = (data || []).map((u, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                <span>${i+1}ìœ„ ${u.nickname || 'ìµëª…'}</span>
                <b>${(u.gold||0).toLocaleString()}G</b>
            </div>
        `).join('');
    }

    async function handleLogout() { 
        await supabaseClient.auth.signOut(); 
        window.location.href = "login.html"; 
    }
    
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // ë°°í‹€ ê´€ë ¨ ë³€ìˆ˜
    let battleSubscription = null;
    let currentBattle = null;
    let myId = null;
    let myNick = '';

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œ í˜¸ì¶œ
    async function loadUserInfo() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            myId = user.id;
            // ì‚¬ìš©ì ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
            const { data: profile } = await supabase
                .from('profiles')
                .select('nickname')
                .eq('id', user.id)
                .single();
            if (profile) {
                myNick = profile.nickname || 'í”Œë ˆì´ì–´';
            }
            
            // ë°°í‹€ ìƒíƒœ êµ¬ë… ì‹œì‘
            setupBattleSubscription();
        }
    }

    // ë°°í‹€ ìƒíƒœ ë³€ê²½ êµ¬ë… ì„¤ì •
    function setupBattleSubscription() {
        // ê¸°ì¡´ êµ¬ë… í•´ì œ
        if (battleSubscription) {
            supabase.removeChannel(battleSubscription);
        }

        // ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
        battleSubscription = supabase
            .channel('battles')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'battles',
                filter: `player1_id=eq.${myId}||player2_id=eq.${myId}`, // ë‚´ê°€ ì°¸ì—¬ì¤‘ì¸ ë°°í‹€ë§Œ í•„í„°ë§
            }, handleBattleUpdate)
            .subscribe();
    }

    // ë°°í‹€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    async function handleBattleUpdate(payload) {
        const battle = payload.new || payload.old;
        
        switch(payload.eventType) {
            case 'INSERT': // ìƒˆ ë°°í‹€ ìƒì„±ë¨
                if (battle.player2_id) { // ìƒëŒ€ë°©ì´ ë§¤ì¹­ëœ ê²½ìš°
                    currentBattle = {
                        id: battle.id,
                        opponent: battle.player2_nickname,
                        opponentId: battle.player2_id,
                        status: 'matching',
                        isMyTurn: battle.current_player_id === myId
                    };
                    updateBattleUI();
                }
                break;
                
            case 'UPDATE': // ë°°í‹€ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (battle.status === 'in_progress') {
                    currentBattle.status = 'in_progress';
                    currentBattle.isMyTurn = battle.current_player_id === myId;
                    updateBattleUI();
                } else if (battle.status === 'completed') {
                    // ë°°í‹€ ê²°ê³¼ ì²˜ë¦¬
                    const isWinner = battle.winner_id === myId;
                    const goldEarned = isWinner ? 100 : 10;
                    
                    // ê³¨ë“œ ì—…ë°ì´íŠ¸
                    const currentGold = parseInt(document.getElementById('u-gold').textContent) || 0;
                    document.getElementById('u-gold').textContent = currentGold + goldEarned;
                    
                    // ê²°ê³¼ í‘œì‹œ
                    showBattleResult(isWinner, battle.winner_nickname, goldEarned);
                    
                    // ì„œë²„ì— ê³¨ë“œ ì—…ë°ì´íŠ¸
                    await updateGold(goldEarned);
                }
                break;
        }
    }

    // ë°°í‹€ ì‹œì‘ í•¨ìˆ˜
    async function startBattle() {
        openModal('battle-matching-modal');
        document.getElementById('matching-status').textContent = 'ìƒëŒ€ë°©ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...';
        
        // ê¸°ì¡´ì— ì§„í–‰ ì¤‘ì¸ ë°°í‹€ì´ ìˆëŠ”ì§€ í™•ì¸
        const { data: existingBattle } = await supabase
            .from('battles')
            .select('*')
            .or(`player1_id.eq.${myId},player2_id.eq.${myId}`)
            .in('status', ['waiting', 'in_progress'])
            .maybeSingle();
            
        if (existingBattle) {
            // ê¸°ì¡´ ë°°í‹€ì´ ìˆìœ¼ë©´ ê·¸ ë°°í‹€ë¡œ ë³µê·€
            currentBattle = {
                id: existingBattle.id,
                opponent: existingBattle.player1_id === myId ? 
                    (existingBattle.player2_nickname || 'ìƒëŒ€ë°©') : 
                    (existingBattle.player1_nickname || 'ìƒëŒ€ë°©'),
                opponentId: existingBattle.player1_id === myId ? 
                    existingBattle.player2_id : 
                    existingBattle.player1_id,
                status: existingBattle.status,
                isMyTurn: existingBattle.current_player_id === myId
            };
            updateBattleUI();
            return;
        }
        
        // ìƒˆë¡œìš´ ë°°í‹€ ìƒì„± ë˜ëŠ” ê¸°ë‹¤ë¦¬ëŠ” ë°°í‹€ì— ì°¸ê°€
        const { data: waitingBattle } = await supabase
            .from('battles')
            .select('*')
            .eq('status', 'waiting')
            .neq('player1_id', myId) // ìê¸° ìì‹ ê³¼ëŠ” ë§¤ì¹­ë˜ì§€ ì•Šë„ë¡
            .maybeSingle();
            
        if (waitingBattle) {
            // ê¸°ë‹¤ë¦¬ëŠ” ë°°í‹€ì´ ìˆìœ¼ë©´ ì°¸ê°€
            const { error } = await supabase
                .from('battles')
                .update({
                    player2_id: myId,
                    player2_nickname: myNick,
                    status: 'in_progress',
                    current_player_id: Math.random() > 0.5 ? myId : waitingBattle.player1_id // ëœë¤ìœ¼ë¡œ ì„ ê³µ ê²°ì •
                })
                .eq('id', waitingBattle.id);
                
            if (error) {
                console.error('ë°°í‹€ ì°¸ê°€ ì‹¤íŒ¨:', error);
                alert('ë°°í‹€ ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                closeModal('battle-matching-modal');
            }
        } else {
            // ìƒˆë¡œìš´ ë°°í‹€ ìƒì„±
            const { data, error } = await supabase
                .from('battles')
                .insert([{
                    player1_id: myId,
                    player1_nickname: myNick,
                    status: 'waiting',
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
                
            if (error) {
                console.error('ë°°í‹€ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ë°°í‹€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                closeModal('battle-matching-modal');
            } else {
                currentBattle = {
                    id: data.id,
                    status: 'waiting',
                    opponent: null,
                    opponentId: null,
                    isMyTurn: false
                };
            }
        }
    }

    // ë°°í‹€ ë§¤ì¹­ ì·¨ì†Œ
    async function cancelBattleMatching() {
        if (currentBattle && currentBattle.status === 'waiting') {
            // ëŒ€ê¸° ì¤‘ì¸ ë°°í‹€ ì‚­ì œ
            await supabase
                .from('battles')
                .delete()
                .eq('id', currentBattle.id);
        }
        currentBattle = null;
        closeModal('battle-matching-modal');
    }

    // ë°°í‹€ UI ì—…ë°ì´íŠ¸
    function updateBattleUI() {
        if (!currentBattle) return;
        
        const statusElement = document.getElementById('matching-status');
        
        if (currentBattle.status === 'waiting') {
            statusElement.textContent = 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...';
        } else if (currentBattle.status === 'in_progress') {
            statusElement.innerHTML = `
                <p>ìƒëŒ€ë°©: <strong>${currentBattle.opponent}</strong></p>
                <p>${currentBattle.isMyTurn ? 'âœ… ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!' : 'â³ ìƒëŒ€ë°©ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤...'}</p>
                <div style="margin-top: 20px;">
                    <button class="btn-update" onclick="makeMove()" ${!currentBattle.isMyTurn ? 'disabled style="opacity:0.5;"' : ''}>
                        ê³µê²©í•˜ê¸°
                    </button>
                </div>
            `;
        }
    }
    
    // ê³µê²©í•˜ê¸°
    async function makeMove() {
        if (!currentBattle || !currentBattle.isMyTurn) return;
        
        // ë°°í‹€ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ í„´ì„ ë„˜ê¸°ëŠ” ê²ƒìœ¼ë¡œ êµ¬í˜„)
        const { error } = await supabase
            .from('battles')
            .update({
                current_player_id: currentBattle.opponentId,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentBattle.id);
            
        if (error) {
            console.error('ê³µê²© ì‹¤íŒ¨:', error);
            return;
        }
        
        // ìŠ¹ë¦¬ íŒì • (ì„ì˜ë¡œ 30% í™•ë¥ ë¡œ ìŠ¹ë¦¬)
        if (Math.random() < 0.3) {
            await endBattle(true);
        }
    }
    
    // ë°°í‹€ ì¢…ë£Œ ì²˜ë¦¬
    async function endBattle(isWinner) {
        const winnerId = isWinner ? myId : currentBattle.opponentId;
        const winnerNick = isWinner ? myNick : currentBattle.opponent;
        
        await supabase
            .from('battles')
            .update({
                status: 'completed',
                winner_id: winnerId,
                winner_nickname: winnerNick,
                completed_at: new Date().toISOString()
            })
            .eq('id', currentBattle.id);
            
        // ê²°ê³¼ í‘œì‹œëŠ” handleBattleUpdateì—ì„œ ì²˜ë¦¬ë¨
    }
    
    // ê³¨ë“œ ì—…ë°ì´íŠ¸
    async function updateGold(amount) {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('gold')
                    .eq('id', user.id)
                    .single();
                
                if (profile) {
                    await supabase
                        .from('profiles')
                        .update({ gold: (parseInt(profile.gold) || 0) + amount })
                        .eq('id', user.id);
                }
            }
        } catch (error) {
            console.error('ê³¨ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ë°°í‹€ ê²°ê³¼ í‘œì‹œ
    function showBattleResult(isWin, winnerNick, goldEarned) {
        const resultTitle = document.getElementById('battle-result-title');
        const resultContent = document.getElementById('battle-result-content');
        
        if (isWin) {
            resultTitle.textContent = 'ğŸ‰ ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰';
            resultContent.innerHTML = `
                <p>ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${winnerNick}</strong>ìœ¼ë¡œ ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                <p style="color: #f39c12; font-weight: bold; font-size: 24px;">+${goldEarned}G íšë“!</p>
            `;
        } else {
            resultTitle.textContent = 'ğŸ˜¢ ì•„ì‰½ê²Œ ì¡ŒìŠµë‹ˆë‹¤...';
            resultContent.innerHTML = `
                <p><strong>${winnerNick}</strong>ë‹˜ì—ê²Œ íŒ¨ë°°í•˜ì…¨ìŠµë‹ˆë‹¤...</p>
                <p>ë‹¤ìŒì—” ê¼­ ì´ê¸°ì„¸ìš”!</p>
                <p>ìœ„ë¡œì˜ ìƒê¸ˆ: ${goldEarned}G</p>
            `;
        }
        
        // ë°°í‹€ ìƒíƒœ ì´ˆê¸°í™”
        currentBattle = null;
        
        // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        openModal('battle-result-modal');
    }

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° ë°°í‹€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    init().then(() => {
        loadUserInfo();
    });
</script>
</body>
</html>
