<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검 강화 게임 - 로그인</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-login { background: #2c3e50; color: white; }
        .btn-login:hover { background: #1a252f; }
        .btn-join { background: #f1f2f6; color: #2c3e50; }
        .btn-join:hover { background: #e2e4e9; }
        .info-text { font-size: 11px; color: #7f8c8d; text-align: center; margin-top: 10px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="login-box">
    <h2>⚔️ 검 강화 게임</h2>
    <input type="tel" id="phone" placeholder="전화번호 (숫자만)" maxlength="11">
    <input type="password" id="pw" placeholder="비밀번호 (6자 이상)">
    <input type="text" id="nick" placeholder="닉네임 (15자 이하)" maxlength="15" style="display: none;">
    
    <button class="btn-login" id="main-btn" onclick="handleAuth()">로그인</button>
    <button class="btn-join" id="sub-btn" onclick="toggleMode()">계정 만들기</button>
    
    <div class="info-text" id="mode-desc">
        닉네임은 한글, 영문, 숫자만 가능합니다.<br>(공백/특수문자 불가, 최대 15자)
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isJoinMode = false;

    // [추가된 기능] 접속 시 이미 로그인되어 있는지 확인
    async function checkLogin() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            // 이미 로그인된 세션이 있다면 index.html로 강제 이동
            location.href = "index.html";
        }
    }

    function toggleMode() {
        isJoinMode = !isJoinMode;
        document.getElementById('nick').style.display = isJoinMode ? 'block' : 'none';
        document.getElementById('main-btn').innerText = isJoinMode ? '회원가입' : '로그인';
        document.getElementById('sub-btn').innerText = isJoinMode ? '로그인하러 가기' : '계정 만들기';
    }

    function validateNickname(nickname) {
        const regex = /^[a-zA-Z0-9가-힣]+$/;
        return regex.test(nickname);
    }

    async function handleAuth() {
        const phone = document.getElementById('phone').value.trim().replace(/[^0-9]/g, "");
        const pw = document.getElementById('pw').value;
        const nick = document.getElementById('nick').value.trim();

        if(!phone || phone.length < 10) return alert("올바른 전화번호를 입력하세요.");
        if(pw.length < 6) return alert("비밀번호는 6자리 이상이어야 합니다.");

        const userIdentifier = `${phone}@phone.game`;

        if (isJoinMode) {
            if(!nick) return alert("닉네임을 입력하세요.");
            if(nick.length > 15) return alert("닉네임은 최대 15자까지 가능합니다.");
            if(!validateNickname(nick)) return alert("닉네임에 공백이나 특수문자를 사용할 수 없습니다.");

            const { data: existingUser, error: checkError } = await supabaseClient
                .from('profiles')
                .select('nickname')
                .eq('nickname', nick)
                .maybeSingle();

            if (checkError) return alert("데이터 확인 중 오류 발생");
            if (existingUser) return alert("이미 존재하는 닉네임입니다.");

            const { data, error } = await supabaseClient.auth.signUp({ 
                email: userIdentifier, 
                password: pw 
            });

            if (error) return alert("가입 실패: " + error.message);

            const { error: profileError } = await supabaseClient.from('profiles').insert([
                { id: data.user.id, nickname: nick, gold: 10000, current_sword_lvl: 1 }
            ]);

            if (profileError) return alert("프로필 생성 실패");

            alert("회원가입 성공! 로그인해주세요.");
            toggleMode();
        } else {
            const { error } = await supabaseClient.auth.signInWithPassword({ 
                email: userIdentifier, 
                password: pw 
            });
            if (error) return alert("로그인 실패: 번호 또는 비밀번호 확인");
            location.href = "index.html";
        }
    }

    // 페이지가 열릴 때 로그인 체크 실행
    checkLogin();
</script>
</body>
</html>
