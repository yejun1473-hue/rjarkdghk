<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²€ ê°•í™” ê²Œì„ - í”Œë ˆì´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ë°°ê²½ */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            background: #e6e9ed; 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; 
            padding: 20px 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ ë””ìì¸ */
        .game-container { 
            width: 100%; 
            max-width: 400px; 
            background: white; 
            border-radius: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
            overflow: hidden; 
            display: none; /* ì´ˆê¸° ë¡œë”© ì „ ìˆ¨ê¹€ */
            position: relative;
        }

        /* ë¡œë”© í™”ë©´ */
        #loading { 
            padding: 100px 0; 
            font-weight: bold; 
            color: #2c3e50; 
            font-size: 1.2rem;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .left-group { display: flex; align-items: center; gap: 12px; }
        
        .home-btn { 
            background: rgba(255,255,255,0.15); 
            border: none; 
            color: white; 
            width: 38px; 
            height: 38px; 
            border-radius: 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s; 
        }
        .home-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }

        .gold-wrap { display: flex; align-items: center; gap: 10px; position: relative; }
        .code-btn { 
            background: #f1c40f; 
            border: none; 
            padding: 6px 10px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 800; 
            cursor: pointer; 
            color: #2c3e50;
            box-shadow: 0 4px 0 #d4ac0d;
        }
        .code-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #d4ac0d; }

        /* NPC ëŒ€í™”ì°½ */
        .npc-box {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
        }
        .npc-box b { color: #3498db; }

        /* ê²€ ì´ë¯¸ì§€ ì˜ì—­ */
        .img-area { 
            background: radial-gradient(circle, #ffffff 0%, #f0f2f5 100%);
            height: 240px; 
            margin: 20px; 
            border-radius: 25px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        .sword-img { 
            max-width: 80%; 
            max-height: 80%; 
            object-fit: contain; 
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
            transition: transform 0.1s;
        }

        /* ê²€ ì •ë³´ í…ìŠ¤íŠ¸ */
        .info-area { padding: 0 25px 20px; text-align: center; }
        #s-name { font-size: 22px; font-weight: 800; color: #2c3e50; margin-bottom: 8px; }
        #s-desc { font-size: 13px; color: #7f8c8d; margin-bottom: 15px; min-height: 18px; }
        .stats-badge {
            background: #edf2f7;
            padding: 10px;
            border-radius: 15px;
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
        }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .btn-group { padding: 20px; display: flex; gap: 10px; background: #fff; }
        .btn-main { 
            flex: 2; 
            padding: 18px; 
            border-radius: 15px; 
            border: none; 
            font-weight: 800; 
            font-size: 17px; 
            cursor: pointer; 
            background: #34495e; 
            color: white; 
            box-shadow: 0 6px 0 #243342;
            transition: 0.1s;
        }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 3px 0 #243342; }
        
        .btn-sub { 
            flex: 1; 
            padding: 18px; 
            border-radius: 15px; 
            border: 2px solid #edf2f7; 
            font-weight: 700; 
            background: #f8f9fa; 
            color: #718096;
            cursor: pointer; 
        }

        /* íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        .hammering { animation: hammer 0.15s infinite; }
        @keyframes hammer { 
            0% { transform: scale(1) rotate(0deg); } 
            50% { transform: scale(1.1) rotate(2deg); } 
            100% { transform: scale(1) rotate(0deg); } 
        }

        .money-float { 
            position: absolute; right: 20px; top: -20px; 
            font-weight: 900; font-size: 24px; 
            animation: floatUp 2s forwards; pointer-events: none; z-index: 100; 
        }
        @keyframes floatUp { 
            0% { opacity: 0; transform: translateY(0); } 
            20% { opacity: 1; } 
            100% { opacity: 0; transform: translateY(-100px); } 
        }

        #full-effect { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            z-index: 9999; display: none; align-items: center; justify-content: center; 
            font-size: 45px; font-weight: 900; color: white; pointer-events: none; 
            text-align: center; text-shadow: 0 5px 15px rgba(0,0,0,0.3);
            white-space: pre-line;
        }

        #ban-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.9); color: white; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            z-index: 10000; text-align: center; 
        }
    </style>
</head>
<body>

<div id="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>

<div id="ban-overlay">
    <i class="fa-solid fa-circle-exclamation" style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;"></i>
    <h2>ì ‘ì†ì´ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.</h2>
    <p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</p>
</div>

<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button class="home-btn" onclick="location.href='index.html'">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-weight: 700;">...ë‹˜</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color: #f1c40f; font-weight: 800; font-size: 18px;">0G</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
        </div>
    </div>

    <div class="npc-box">
        <b>ë£¨ëŒí”„ : </b> <span id="npc-text">ë°˜ê°‘ë„¤! ì˜¤ëŠ˜ì€ ì–´ë–¤ ê²€ì„ ê°•í™”í•´ë³¼ í…ê°€?</span>
    </div>
    
    <div class="img-area">
        <img id="s-img" src="" class="sword-img">
    </div>
    
    <div class="info-area">
        <div id="s-name">...</div>
        <div id="s-desc">...</div>
        <div class="stats-badge">
            <span><i class="fa-solid fa-hammer"></i> ê°•í™”: <span id="stat-cost">0</span>G</span>
            <span><i class="fa-solid fa-sack-dollar"></i> íŒë§¤: <span id="stat-sell">0</span>G</span>
            <span><i class="fa-solid fa-percent"></i> í™•ë¥ : <span id="stat-rate">0</span>%</span>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    // --- ì„¤ì •ë¶€ ---
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {}; 

    const fallbackSwords = {
        1: { level: 1, name: "ë‚¡ì€ ëª©ê²€", description: "í‰ë²”í•œ ì—°ìŠµìš© ëª©ê²€ì…ë‹ˆë‹¤.", upgrade_cost: 100, sell_price: 0, success_rate: 0.9, image_url: "https://via.placeholder.com/200?text=Sword+1" }
    };

    // --- ì´ˆê¸°í™” ---
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }

            const { data: p, error: pErr } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            if (pErr) throw pErr;
            if (p.is_banned) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ban-overlay').style.display = 'flex';
                return;
            }
            user = p;

            // ë ˆë²¨ 0 ë³´ì • ë¡œì§
            if (!user.current_sword_lvl || user.current_sword_lvl < 1) {
                user.current_sword_lvl = 1;
                await supabaseClient.from('profiles').update({ current_sword_lvl: 1 }).eq('id', user.id);
            }

            const { data: sData } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
            if (sData && sData.length > 0) {
                sData.forEach(item => { swords[item.level] = item; });
            } else {
                swords = { ...fallbackSwords };
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();

        } catch (e) {
            console.error(e);
            alert("ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function updateUI() {
        if (!user) return;
        let item = swords[user.current_sword_lvl] || swords[1] || fallbackSwords[1];

        document.getElementById('u-nick').innerText = (user.nickname || "ì—¬í–‰ì") + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById('stat-cost').innerText = item.upgrade_cost.toLocaleString();
        document.getElementById('stat-sell').innerText = (item.sell_price || 0).toLocaleString();
        document.getElementById('stat-rate').innerText = Math.round(item.success_rate * 100);
        document.getElementById('s-img').src = item.image_url;
    }

    async function handleUpgrade() {
        const currentItem = swords[user.current_sword_lvl] || swords[1];
        if (user.gold < currentItem.upgrade_cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        showGoldEffect(currentItem.upgrade_cost, false);

        const isSuccess = Math.random() < currentItem.success_rate;
        let nextLvl = isSuccess ? user.current_sword_lvl + 1 : Math.max(1, user.current_sword_lvl - 1);

        if (isSuccess && !swords[nextLvl]) {
            img.classList.remove('hammering');
            return alert("ì´ë¯¸ ì‹ ì˜ ê²½ì§€ì— ë„ë‹¬í•œ ê²€ì…ë‹ˆë‹¤!");
        }

        user.gold -= currentItem.upgrade_cost;
        const { error } = await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);

        if (error) return alert("í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");

        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = nextLvl;
            showEffect(isSuccess);
            updateUI();
        }, 600);
    }

    async function handleSell() {
        if (user.current_sword_lvl === 1) return alert("ê¸°ë³¸ ê²€ì€ íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const item = swords[user.current_sword_lvl];
        const price = item.sell_price || 0;

        if (!confirm(`${item.name}ì„ ${price.toLocaleString()}Gì— íŒŒì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        user.gold += price;
        user.current_sword_lvl = 1;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);

        showGoldEffect(price, true);
        updateUI();
    }

    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(46, 204, 113, 0.85)' : 'rgba(231, 76, 60, 0.85)';
        el.innerText = success ? "ğŸ”¨ ê°•í™” ì„±ê³µ!!" : "ğŸ’¥ ê°•í™” ì‹¤íŒ¨!\në ˆë²¨ í•˜ë½";
        setTimeout(() => { el.style.display = 'none'; }, 800);
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#2ecc71' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 2000);
    }

    async function redeem() {
        const code = prompt("ë³´ë¬¼ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!code) return;
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if (!data) return alert("ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.");
        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        showGoldEffect(data.reward_gold, true);
        updateUI();
    }

    init();
</script>
</body>
</html>
