<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Up Sword</title>
    
    <link rel="icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <link rel="shortcut icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    
    <meta property="og:title" content="Up Sword">
    <meta property="og:image" content="https://i.ifh.cc/rvTcHw.jpg">
    <meta property="og:description" content="자체 제작 강화게임 Up Sword">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Pretendard 폰트 및 기본 테마 설정 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* 컨테이너 디자인 */
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #1a202c; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header .home-btn { color: white; text-decoration: none; font-size: 18px; padding: 5px 10px; border-radius: 8px; transition: 0.2s; }
        .header .home-btn:hover { background: rgba(255,255,255,0.1); }
        .header h1 { font-size: 20px; margin: 0; font-weight: 800; letter-spacing: -0.5px; }

        .currency-info { display: flex; gap: 10px; padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #edf2f7; justify-content: center; }
        .currency-box { background: white; padding: 8px 15px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px; }
        .currency-box.gold { color: #d69e2e; }
        .currency-box.money { color: #38a169; }

        .game-area { padding: 30px 20px; text-align: center; }
        .sword-display { height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; }
        .sword-img { width: 140px; height: 140px; object-fit: contain; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); transition: transform 0.1s; }
        .sword-level { position: absolute; top: -10px; right: 50%; transform: translateX(80px); background: #e53e3e; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .info-card { background: #f8fafc; border-radius: 16px; padding: 15px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { text-align: center; }
        .info-label { font-size: 11px; color: #718096; margin-bottom: 4px; display: block; font-weight: 600; }
        .info-value { font-size: 15px; font-weight: 800; color: #2d3748; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        .main-btn { padding: 18px; border: none; border-radius: 16px; font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-upgrade { background: #3182ce; color: white; box-shadow: 0 6px 0 #2b6cb0; }
        .btn-upgrade:active { transform: translateY(4px); box-shadow: 0 2px 0 #2b6cb0; }
        .btn-sell { background: #edf2f7; color: #4a5568; font-size: 16px; }
        .btn-sell:hover { background: #e2e8f0; }

        .admin-trigger { position: fixed; bottom: 10px; right: 10px; width: 30px; height: 30px; opacity: 0.1; cursor: default; }
        
        /* 애니메이션 효과 */
        .upgrade-success { animation: success-pulse 0.5s ease-out; }
        @keyframes success-pulse {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* 플로팅 텍스트 */
        .float-text { position: absolute; font-weight: 900; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 100; }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }
    </style>
</head>
<body>

<div class="game-container" id="game-ui">
    <div class="header">
        <a href="index.html" class="home-btn"><i class="fas fa-home"></i></a>
        <h1>SWORD UPGRADE</h1>
        <div style="width: 38px;"></div>
    </div>

    <div class="currency-info">
        <div class="currency-box gold">
            <i class="fas fa-coins"></i> <span id="u-gold">0</span>
        </div>
        <div class="currency-box money">
            <i class="fas fa-wallet"></i> <span id="u-money">0</span>
        </div>
    </div>

    <div class="game-area">
        <div class="sword-display" id="sword-container">
            <span class="sword-level" id="sword-lvl-badge">LV. 1</span>
            <img src="https://i.ifh.cc/Y15g2p.png" class="sword-img" id="sword-img">
        </div>

        <div class="info-card">
            <div class="info-item">
                <span class="info-label">강화 비용</span>
                <span class="info-value" id="upgrade-cost">1,000G</span>
            </div>
            <div class="info-item">
                <span class="info-label">강화 확률</span>
                <span class="info-value" id="success-rate">95%</span>
            </div>
            <div class="info-item">
                <span class="info-label">판매 가격</span>
                <span class="info-value" id="sell-price">500M</span>
            </div>
            <div class="info-item">
                <span class="info-label">현재 등급</span>
                <span class="info-value" id="sword-rank">일반</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="main-btn btn-upgrade" onclick="upgradeSword()">강화하기</button>
            <button class="main-btn btn-sell" onclick="sellSword()">검 판매하기</button>
            <button class="main-btn btn-sell" style="margin-top:5px; font-size:12px; padding:10px;" onclick="redeem()">쿠폰 입력</button>
        </div>
    </div>
</div>

<div class="admin-trigger" onclick="adminAuth()"></div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null;
    let isProcessing = false;

    // 검 레벨별 이미지 (이미지 시안에 따라 추가 가능)
    const SWORD_IMAGES = {
        default: "https://i.ifh.cc/Y15g2p.png",
        high: "https://i.ifh.cc/Y15g2p.png" // 추후 레벨별 이미지 변경 시 사용
    };

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { location.href = "login.html"; return; }

        const { data: p, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(error || !p) { location.href = "login.html"; return; }

        user = p;
        updateUI();
        document.getElementById('game-ui').style.display = 'block';
    }

    function getLevelData(lvl) {
        return {
            cost: Math.floor(1000 * Math.pow(1.5, lvl - 1)),
            rate: Math.max(5, 100 - (lvl * 4)),
            price: Math.floor(500 * Math.pow(1.4, lvl - 1)),
            rank: lvl >= 20 ? '신화' : lvl >= 15 ? '전설' : lvl >= 10 ? '유니크' : lvl >= 5 ? '레어' : '일반'
        };
    }

    function updateUI() {
        const data = getLevelData(user.current_sword_lvl);
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString();
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString();
        document.getElementById('sword-lvl-badge').innerText = `LV. ${user.current_sword_lvl}`;
        document.getElementById('upgrade-cost').innerText = `${data.cost.toLocaleString()}G`;
        document.getElementById('success-rate').innerText = `${data.rate}%`;
        document.getElementById('sell-price').innerText = `${data.price.toLocaleString()}M`;
        document.getElementById('sword-rank').innerText = data.rank;
    }

    async function upgradeSword() {
        if(isProcessing) return;
        const data = getLevelData(user.current_sword_lvl);

        if(user.gold < data.cost) {
            alert("골드가 부족합니다!");
            return;
        }

        isProcessing = true;
        user.gold -= data.cost;
        
        const rand = Math.random() * 100;
        const isSuccess = rand <= data.rate;

        if(isSuccess) {
            user.current_sword_lvl += 1;
            showGoldEffect("SUCCESS!", true);
            document.getElementById('sword-img').classList.add('upgrade-success');
            setTimeout(() => document.getElementById('sword-img').classList.remove('upgrade-success'), 500);
        } else {
            // 실패 시 5레벨마다 세이프티 존 (선택사항)
            if(user.current_sword_lvl > 1) {
                user.current_sword_lvl -= 1;
            }
            showGoldEffect("FAILED", false);
        }

        updateUI();
        await saveProgress();
        isProcessing = false;
    }

    async function sellSword() {
        if(user.current_sword_lvl === 1) return alert("1레벨 검은 판매할 수 없습니다.");
        const data = getLevelData(user.current_sword_lvl);
        
        if(!confirm(`${user.current_sword_lvl}레벨 검을 ${data.price.toLocaleString()}M에 판매하시겠습니까?`)) return;

        user.money = (user.money || 0) + data.price;
        user.current_sword_lvl = 1;
        
        updateUI();
        await saveProgress();
        alert("판매 완료!");
    }

    async function saveProgress() {
        await supabaseClient.from('profiles').update({
            gold: user.gold,
            money: user.money,
            current_sword_lvl: user.current_sword_lvl
        }).eq('id', user.id);
    }

    function showGoldEffect(text, success) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;
        el.style.color = success ? '#3182ce' : '#e53e3e';
        el.style.left = '50%';
        el.style.top = '40%';
        document.getElementById('sword-container').appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    // 관리자 패널 로직
    function adminAuth() {
        const pw = prompt("관리자 암호");
        if(pw === "yejun123") showAdminPanel();
    }

    async function showAdminPanel() {
        const { data: users } = await supabaseClient.from('profiles').select('*');
        let html = '<div id="admin-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto;">';
        html += '<h2>관리자 패널 <button onclick="this.parentElement.parentElement.remove()">닫기</button></h2>';
        users.forEach(u => {
            html += `<div style="border-bottom:1px solid #ddd; padding:10px;">
                ${u.nickname} (LV.${u.current_sword_lvl}) | Gold: ${u.gold} | Money: ${u.money}
                <button onclick="editUser('${u.id}')">수정</button>
            </div>`;
        });
        html += '</div>';
        document.body.insertAdjacentHTML('beforeend', html);
    }

    window.editUser = async (id) => {
        const gold = prompt("새 골드");
        const money = prompt("새 머니");
        const lvl = prompt("새 레벨");
        await supabaseClient.from('profiles').update({
            gold: parseInt(gold),
            money: parseInt(money),
            current_sword_lvl: parseInt(lvl)
        }).eq('id', id);
        alert('반영됨');
        location.reload();
    };

    async function redeem() {
        const code = prompt("코드 입력");
        if (!code) return;
        
        try {
            const { data, error } = await supabaseClient
                .from('reward_codes')
                .select('*')
                .eq('code', code)
                .single();
                
            if (error || !data) {
                return alert("유효하지 않은 코드입니다.");
            }
            
            user.gold += data.reward_gold;
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ gold: user.gold })\
                .eq('id', user.id);
                
            if (updateError) throw updateError;
            
            showGoldEffect(data.reward_gold, true);
            updateUI();
            alert(`성공적으로 ${data.reward_gold.toLocaleString()}G를 지급받았습니다!`);
            
            await supabaseClient
                .from('reward_codes')
                .delete()
                .eq('code', code);
                
        } catch (e) {
            console.error('Error redeeming code:', e);
            alert('코드 사용 중 오류가 발생했습니다.');
        }
    }

    init();
</script>
</body>
</html>
