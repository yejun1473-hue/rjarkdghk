<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>검 강화 게임 - 플레이</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Pretendard 폰트 및 기본 테마 설정 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* 컨테이너 디자인 */
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #1a202c; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* 검 이미지 영역 */
        .img-area { background: #edf2f7; height: 260px; margin: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); transition: transform 0.1s; }
        
        /* 강화 정보 영역 */
        .info-area { padding: 0 24px 24px; text-align: center; }
        #s-name { font-size: 24px; font-weight: 800; color: #2d3748; }
        #s-desc { font-size: 14px; color: #718096; margin: 8px 0 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #f8fafc; padding: 12px; border-radius: 16px; font-size: 13px; font-weight: 600; }
        
        /* 버튼 스타일 */
        .btn-group { padding: 0 20px 24px; display: flex; gap: 12px; }
        .btn-main { flex: 2; padding: 18px; border-radius: 16px; border: none; background: #2d3748; color: white; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #1a202c; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #1a202c; }
        .btn-sub { flex: 1; padding: 18px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; color: #4a5568; font-weight: 700; cursor: pointer; }
    .gold-wrap { display: flex; align-items: center; gap: 10px; }
    .code-btn { padding: 5px 12px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
    .money-float { position: absolute; animation: floatUp 1s forwards; font-weight: bold; font-size: 14px; pointer-events: none; }
    @keyframes floatUp { to { transform: translateY(-30px); opacity: 0; } }

        /* 애니메이션 효과 */
        .hammering { animation: shake 0.15s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 50% { transform: rotate(3deg); } 100% { transform: rotate(0); } }
        #full-effect { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: 900; pointer-events: none; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 50px;">데이터를 동기화 중입니다...</div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button onclick="location.href='index.html'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" title="홈으로">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-size: 14px;">...</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color:#f1c40f; font-weight: bold; margin-right: 10px;">0G</span>
            <span id="u-money" style="color:#9b59b6; font-weight: bold;">0M</span>
            <button class="code-btn" onclick="redeem()">코드</button>
            <button id="adminBtn" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; display:none; margin-left: 10px;">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </div>

    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>

    <div class="info-area">
        <div id="s-name">검 정보</div>
        <div id="s-desc">검 설명</div>
        <div class="stats-grid">
            <div><i class="fa-solid fa-hammer"></i> <span id="stat-cost">0</span>G</div>
            <div><i class="fa-solid fa-sack-dollar"></i> <span id="stat-sell">0</span>G</div>
            <div><i class="fa-solid fa-percent"></i> <span id="stat-rate">0</span>%</div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">판매</button>
        <button class="btn-main" onclick="handleUpgrade()">강화하기</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {};
    let isAdmin = false;
    let allUsers = [];

    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }

            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;

            // Level 0 방어 로직
            if (!user.current_sword_lvl || user.current_sword_lvl < 1) {
                user.current_sword_lvl = 1;
                await supabaseClient.from('profiles').update({ current_sword_lvl: 1 }).eq('id', user.id);
            }

            const { data: sData } = await supabaseClient.from('sword_data').select('*').order('level');
            sData.forEach(d => swords[d.level] = d);

            // Check if user is admin
            isAdmin = user.email === 'admin@example.com'; // 관리자 이메일로 변경 필요
            if (isAdmin) {
                document.getElementById('adminBtn').style.display = 'block';
                document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
                await loadAllUsers();
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
        } catch (e) { alert("로그인이 만료되었거나 데이터 오류가 발생했습니다."); }
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-nick').innerText = (user.username || '플레이어') + '님';
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString() + "G";
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString() + "M";
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description;
        document.getElementById('stat-cost').innerText = item.upgrade_cost.toLocaleString();
        document.getElementById('stat-sell').innerText = (item.sell_price || 0).toLocaleString();
        document.getElementById('stat-rate').innerText = Math.round(item.success_rate * 100);
        document.getElementById('s-img').src = item.image_url;
    }

    async function handleUpgrade() {
        const currentLevel = user.current_sword_lvl;
        const currentSword = swords[currentLevel];
        
        // Get enhancement rates based on current level
        const rates = getEnhancementRates(currentLevel);
        
        if (user.gold < currentSword.upgrade_cost) return alert("골드가 부족합니다!");
        if (currentLevel >= 20) return alert("최대 강화 레벨(20)에 도달했습니다!");

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        
        // Deduct gold first
        user.gold -= currentSword.upgrade_cost;
        
        // Determine enhancement result
        const result = determineEnhancementResult(rates);
        let newLevel = currentLevel;
        let message = "";
        
        switch(result) {
            case 'success':
                newLevel = currentLevel + 1;
                message = `강화 성공! [+${newLevel}레벨]`;
                break;
            case 'maintain':
                message = "강화 실패! (유지)";
                break;
            case 'drop':
                newLevel = Math.max(0, currentLevel - 1);
                message = `강화 실패! (${newLevel}레벨로 하락)`;
                break;
            case 'destroy':
                newLevel = 0;
                message = "강화 실패! (검 파괴)";
                break;
        }
        
        // Update user data
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                gold: user.gold, 
                current_sword_lvl: newLevel 
            })
            .eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = newLevel;
            showEffect(result === 'success', message);
            updateUI();
        }, 600);
    }
    
    function getEnhancementRates(level) {
        // Format: { success: %, maintain: %, drop: %, destroy: % }
        const rates = {
            0: { success: 95, maintain: 5, drop: 0, destroy: 0 },
            1: { success: 90, maintain: 10, drop: 0, destroy: 0 },
            2: { success: 85, maintain: 15, drop: 0, destroy: 0 },
            3: { success: 80, maintain: 20, drop: 0, destroy: 0 },
            4: { success: 75, maintain: 25, drop: 0, destroy: 0 },
            5: { success: 70, maintain: 20, drop: 10, destroy: 0 },
            6: { success: 65, maintain: 15, drop: 15, destroy: 5 },
            7: { success: 60, maintain: 10, drop: 20, destroy: 10 },
            8: { success: 55, maintain: 5, drop: 25, destroy: 15 },
            9: { success: 50, maintain: 0, drop: 30, destroy: 20 },
            10: { success: 45, maintain: 0, drop: 35, destroy: 20 },
            11: { success: 40, maintain: 0, drop: 35, destroy: 25 },
            12: { success: 35, maintain: 0, drop: 40, destroy: 25 },
            13: { success: 30, maintain: 0, drop: 45, destroy: 25 },
            14: { success: 25, maintain: 0, drop: 45, destroy: 30 },
            15: { success: 20, maintain: 0, drop: 45, destroy: 35 },
            16: { success: 15, maintain: 0, drop: 45, destroy: 40 },
            17: { success: 10, maintain: 0, drop: 45, destroy: 45 },
            18: { success: 5, maintain: 0, drop: 45, destroy: 50 },
            19: { success: 1, maintain: 0, drop: 49, destroy: 50 }
        };
        return rates[level] || rates[0];
    }
    
    function determineEnhancementResult(rates) {
        const rand = Math.random() * 100;
        let cumulative = 0;
        
        for (const [result, probability] of Object.entries(rates)) {
            cumulative += probability;
            if (rand < cumulative) {
                return result;
            }
        }
        
        return 'maintain'; // Default fallback
    }

    async function handleSell() {
        if (user.current_sword_lvl === 1) return alert("기본 검은 판매할 수 없습니다.");
        const price = swords[user.current_sword_lvl].sell_price || 0;
        if (!confirm(`${price}G에 판매하시겠습니까?`)) return;

        user.gold += price;
        user.current_sword_lvl = 1;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);
        updateUI();
    }

    function showEffect(win, message) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = win ? 'rgba(72, 187, 120, 0.9)' : 'rgba(245, 101, 101, 0.9)';
        el.innerText = message || (win ? "강화 성공!!" : "강화 실패!");
        setTimeout(() => el.style.display = 'none', 1000);
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    async function loadAllUsers() {
        const { data } = await supabaseClient.from('profiles').select('id, username, gold, current_sword_lvl, email');
        allUsers = data || [];
    }

    function showAdminPanel() {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        let content = `
            <div style="background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <h2>관리자 패널</h2>
                <div style="margin-bottom: 20px;">
                    <h3>사용자 목록</h3>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                        ${allUsers.map(u => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${u.username || u.email}</strong>
                                <div>골드: <input type="number" id="gold-${u.id}" value="${u.gold || 0}" style="width: 80px;"></div>
                                <div>머니: <input type="number" id="money-${u.id}" value="${u.money || 0}" style="width: 80px;"></div>
                                <div>레벨: <input type="number" id="level-${u.id}" value="${u.current_sword_lvl}" min="1" max="20" style="width: 60px;"></div>
                                <button onclick="updateUser('${u.id}')" style="margin-top: 5px; padding: 2px 8px; font-size: 12px;">수정</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="this.parentNode.parentNode.remove()" style="padding: 8px 20px; background: #2d3748; color: white; border: none; border-radius: 5px; cursor: pointer;">닫기</button>
            </div>
        `;
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Add the updateUser function to the window object
        window.updateUser = async (userId) => {
            const gold = parseInt(document.getElementById(`gold-${userId}`).value) || 0;
            const money = parseInt(document.getElementById(`money-${userId}`).value) || 0;
            let level = parseInt(document.getElementById(`level-${userId}`).value) || 1;
            
            // Enforce max level of 20
            level = Math.min(level, 20);
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ gold, money, current_sword_lvl: level })
                    .eq('id', userId);
                
                if (error) throw error;
                alert('사용자 정보가 업데이트되었습니다.');
                await loadAllUsers();
                modal.remove();
                showAdminPanel(); // Refresh the panel
            } catch (e) {
                alert('업데이트 중 오류가 발생했습니다: ' + e.message);
            }
        };
    }

    async function redeem() {
        const code = prompt("코드 입력");
        if (!code) return;
        
        try {
            const { data, error } = await supabaseClient
                .from('reward_codes')
                .select('*')
                .eq('code', code)
                .single();
                
            if (error || !data) {
                return alert("유효하지 않은 코드입니다.");
            }
            
            user.gold += data.reward_gold;
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ gold: user.gold })
                .eq('id', user.id);
                
            if (updateError) throw updateError;
            
            showGoldEffect(data.reward_gold, true);
            updateUI();
            alert(`성공적으로 ${data.reward_gold.toLocaleString()}G를 지급받았습니다!`);
            
            // 코드 사용 처리 (선택사항)
            await supabaseClient
                .from('reward_codes')
                .delete()
                .eq('code', code);
                
        } catch (e) {
            console.error('Error redeeming code:', e);
            alert('코드 사용 중 오류가 발생했습니다.');
        }
    }

    init();
</script>
</body>
</html>
