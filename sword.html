<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>검 강화 게임 - 플레이</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Pretendard 폰트 및 기본 테마 설정 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* 컨테이너 디자인 */
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #1a202c; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* 검 이미지 영역 */
        .img-area { background: #edf2f7; height: 260px; margin: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); transition: transform 0.1s; }
        
        /* 강화 정보 영역 */
        .info-area { padding: 0 24px 24px; text-align: center; }
        #s-name { font-size: 24px; font-weight: 800; color: #2d3748; }
        #s-desc { font-size: 14px; color: #718096; margin: 8px 0 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #f8fafc; padding: 12px; border-radius: 16px; font-size: 13px; font-weight: 600; }
        
        /* 버튼 스타일 */
        .btn-group { padding: 0 20px 24px; display: flex; gap: 12px; }
        .btn-main { flex: 2; padding: 18px; border-radius: 16px; border: none; background: #2d3748; color: white; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #1a202c; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #1a202c; }
        .btn-sub { flex: 1; padding: 18px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; color: #4a5568; font-weight: 700; cursor: pointer; }

        /* 애니메이션 효과 */
        .hammering { animation: shake 0.15s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 50% { transform: rotate(3deg); } 100% { transform: rotate(0); } }
        #full-effect { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: 900; pointer-events: none; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 50px;">데이터를 동기화 중입니다...</div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <button onclick="location.href='index.html'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;"><i class="fa-solid fa-house"></i></button>
        <div id="u-gold" style="color:#ecc94b; font-weight:800; font-size:18px;">0G</div>
    </div>

    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>

    <div class="info-area">
        <div id="s-name">검 정보</div>
        <div id="s-desc">검 설명</div>
        <div class="stats-grid">
            <div><i class="fa-solid fa-hammer"></i> <span id="stat-cost">0</span>G</div>
            <div><i class="fa-solid fa-sack-dollar"></i> <span id="stat-sell">0</span>G</div>
            <div><i class="fa-solid fa-percent"></i> <span id="stat-rate">0</span>%</div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">판매</button>
        <button class="btn-main" onclick="handleUpgrade()">강화하기</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {};

    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }

            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;

            // Level 0 방어 로직
            if (!user.current_sword_lvl || user.current_sword_lvl < 1) {
                user.current_sword_lvl = 1;
                await supabaseClient.from('profiles').update({ current_sword_lvl: 1 }).eq('id', user.id);
            }

            const { data: sData } = await supabaseClient.from('sword_data').select('*').order('level');
            sData.forEach(d => swords[d.level] = d);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
        } catch (e) { alert("로그인이 만료되었거나 데이터 오류가 발생했습니다."); }
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description;
        document.getElementById('stat-cost').innerText = item.upgrade_cost.toLocaleString();
        document.getElementById('stat-sell').innerText = (item.sell_price || 0).toLocaleString();
        document.getElementById('stat-rate').innerText = Math.round(item.success_rate * 100);
        document.getElementById('s-img').src = item.image_url;
    }

    async function handleUpgrade() {
        const current = swords[user.current_sword_lvl];
        if (user.gold < current.upgrade_cost) return alert("골드가 부족합니다!");

        const img = document.getElementById('s-img');
        img.classList.add('hammering');

        const success = Math.random() < current.success_rate;
        // 실패 시 1레벨 미만으로 떨어지지 않게 고정
        let nextLvl = success ? user.current_sword_lvl + 1 : Math.max(1, user.current_sword_lvl - 1);

        if (success && !swords[nextLvl]) {
            img.classList.remove('hammering');
            return alert("이미 신화적인 경지에 도달했습니다!");
        }

        user.gold -= current.upgrade_cost;
        const { error } = await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = nextLvl;
            showEffect(success);
            updateUI();
        }, 600);
    }

    async function handleSell() {
        if (user.current_sword_lvl === 1) return alert("기본 검은 판매할 수 없습니다.");
        const price = swords[user.current_sword_lvl].sell_price || 0;
        if (!confirm(`${price}G에 판매하시겠습니까?`)) return;

        user.gold += price;
        user.current_sword_lvl = 1;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);
        updateUI();
    }

    function showEffect(win) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = win ? 'rgba(72, 187, 120, 0.9)' : 'rgba(245, 101, 101, 0.9)';
        el.innerText = win ? "강화 성공!" : "강화 실패...";
        setTimeout(() => el.style.display = 'none', 800);
    }

    init();
</script>
</body>
</html>
